@* filepath: d:\GAM106-ASM\Views\Admin\Players.cshtml *@
@model IEnumerable<WebApplication1.Models.Player>
@{
    ViewData["Title"] = "Players Management";
}

<div class="container mt-4">
    <h2>Players</h2>
    <a href="@Url.Action("Index", "Admin")" class="btn btn-secondary mb-3">← Back to Dashboard</a>
    <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#playerModal" onclick="openCreateModal()">+ Add New Player</button>
    
    <table class="table table-striped table-bordered" id="playersTable">
        <thead>
            <tr>
                <th>Id</th>
                <th>Account</th>
                <th>Realm</th>
                <th>Hunger</th>
                <th>XP</th>
                <th>Mode</th>
                <th>Created At</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var player in Model)
            {
                <tr>
                    <td>@player.Id</td>
                    <td>@player.Account?.Username</td>
                    <td>@player.Realm</td>
                    <td>@player.Hunger</td>
                    <td>@player.Xp</td>
                    <td>@player.CurrentMode?.Name</td>
                    <td>@player.CreatedAt?.ToString("yyyy-MM-dd HH:mm")</td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick='openEditModal(@Html.Raw(Json.Serialize(new { 
                            id = player.Id, 
                            accountId = player.AccountId, 
                            realm = player.Realm, 
                            hunger = player.Hunger, 
                            xp = player.Xp,
                            currentModeId = player.CurrentModeId
                        })))'>Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteItem('/api/Player/@player.Id')">Delete</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- Modal -->
<div class="modal fade" id="playerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Add Player</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="playerForm">
                    <input type="hidden" id="playerId">
                    <div class="mb-3">
                        <label for="accountId" class="form-label">Account ID</label>
                        <input type="text" class="form-control" id="accountId" required>
                    </div>
                    <div class="mb-3">
                        <label for="realm" class="form-label">Realm</label>
                        <input type="number" class="form-control" id="realm" value="1" required>
                    </div>
                    <div class="mb-3">
                        <label for="hunger" class="form-label">Hunger</label>
                        <input type="number" class="form-control" id="hunger" value="100" required>
                    </div>
                    <div class="mb-3">
                        <label for="xp" class="form-label">XP</label>
                        <input type="number" class="form-control" id="xp" value="0" required>
                    </div>
                    <div class="mb-3">
                        <label for="currentModeId" class="form-label">Game Mode ID</label>
                        <input type="text" class="form-control" id="currentModeId" value="1">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="savePlayer()">Save</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            $('#playersTable').DataTable();
        });

        let isEditMode = false;

        function openCreateModal() {
            isEditMode = false;
            document.getElementById('modalTitle').textContent = 'Add Player';
            document.getElementById('playerForm').reset();
            document.getElementById('playerId').value = '';
        }

        function openEditModal(player) {
            isEditMode = true;
            document.getElementById('modalTitle').textContent = 'Edit Player';
            document.getElementById('playerId').value = player.id;
            document.getElementById('accountId').value = player.accountId;
            document.getElementById('realm').value = player.realm;
            document.getElementById('hunger').value = player.hunger;
            document.getElementById('xp').value = player.xp;
            document.getElementById('currentModeId').value = player.currentModeId || '1';
            
            const modal = new bootstrap.Modal(document.getElementById('playerModal'));
            modal.show();
        }

        function savePlayer() {
            const id = document.getElementById('playerId').value;
            let data;
            if (isEditMode) {
                // Edit: gửi id
                data = {
                    id: parseInt(id),
                    accountId: document.getElementById('accountId').value,
                    realm: parseInt(document.getElementById('realm').value),
                    hunger: parseInt(document.getElementById('hunger').value),
                    xp: parseInt(document.getElementById('xp').value),
                    currentModeId: document.getElementById('currentModeId').value || '1'
                };
            } else {
                // Create: KHÔNG gửi id
                data = {
                    accountId: document.getElementById('accountId').value,
                    realm: parseInt(document.getElementById('realm').value),
                    hunger: parseInt(document.getElementById('hunger').value),
                    xp: parseInt(document.getElementById('xp').value),
                    currentModeId: document.getElementById('currentModeId').value || '1'
                };
            }

            const url = isEditMode ? `/api/Player/${id}` : '/api/Player';
            const method = isEditMode ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(async res => {
                const contentType = res.headers.get('content-type');
                if (res.ok) {
                    alert(isEditMode ? 'Player updated successfully!' : 'Player created successfully!');
                    location.reload();
                } else {
                    if (contentType && contentType.includes('application/json')) {
                        const errorData = await res.json();
                        throw new Error(errorData.message || errorData.error || 'Unknown error');
                    } else {
                        const errorText = await res.text();
                        throw new Error(errorText || `Error ${res.status}`);
                    }
                }
            })
            .catch(err => {
                console.error('Error:', err);
                alert('Error: ' + err.message);
            });
        }

        function deleteItem(url) {
            if (confirm('Are you sure you want to delete this player?\n\nThis will also delete:\n- Inventory items\n- Monster kills\n- Quests\n- Transactions')) {
                fetch(url, { 
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(async res => {
                    const contentType = res.headers.get('content-type');
                    
                    if (res.ok) {
                        if (contentType && contentType.includes('application/json')) {
                            const data = await res.json();
                            alert(data.message || 'Player deleted successfully!');
                        } else {
                            alert('Player deleted successfully!');
                        }
                        location.reload();
                    } else {
                        if (contentType && contentType.includes('application/json')) {
                            const errorData = await res.json();
                            throw new Error(errorData.message || errorData.error || 'Delete failed');
                        } else {
                            const errorText = await res.text();
                            throw new Error(errorText || `Delete failed: ${res.status}`);
                        }
                    }
                })
                .catch(err => {
                    console.error('Delete error:', err);
                    alert('Delete failed: ' + err.message);
                });
            }
        }
    </script>
}